<!DOCTYPE html>
<html>
<head>
    <title>Teste Compressão Imagens</title>
</head>
<body>
    <h1>Teste de Compressão de Imagens</h1>
    <button id="compressBtn">Comprimir Todas as Imagens</button>
    <div id="progress"></div>
    <div id="results"></div>

    <script src="src/js/database.js"></script>
    <script src="src/js/utils/BatchImageOptimizer.js"></script>
    <script>
        // Aguardar scripts carregarem
        window.addEventListener('load', () => {
            const database = window.database || new LocalDatabase();
            const optimizer = new BatchImageOptimizer(database);
        
        document.getElementById('compressBtn').addEventListener('click', async () => {
            const progressDiv = document.getElementById('progress');
            const resultsDiv = document.getElementById('results');
            
            progressDiv.innerHTML = 'Iniciando compressão...';
            
            try {
                const result = await optimizer.optimizeAllImages({
                    createBackup: true,
                    skipIfOptimized: false, // Forçar compressão
                    maxConcurrent: 2,
                    onProgress: (progress) => {
                        const pct = Math.round((progress.current / progress.total) * 100);
                        progressDiv.innerHTML = `Processando ${progress.current}/${progress.total} (${pct}%)...`;
                    }
                });
                
                resultsDiv.innerHTML = `
                    <h3>Resultados:</h3>
                    <p>Total: ${result.total}</p>
                    <p>Otimizadas: ${result.optimized}</p>
                    <p>Puladas: ${result.skipped}</p>
                    <p>Erros: ${result.errors}</p>
                    <p>Economia: ${formatFileSize(result.savings)}</p>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `Erro: ${error.message}`;
            }
        });
        
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html>