<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Teste de Integra√ß√£o Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result { margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid; }
        .pass { background: #d4edda; border-color: #28a745; color: #155724; }
        .fail { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
        .loading { background: #fff3cd; border-color: #ffc107; color: #856404; }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-5xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center">üöÄ Teste de Integra√ß√£o Supabase</h1>
        
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Status da Migra√ß√£o</h2>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <strong>Antes:</strong> localStorage (dados locais)
                </div>
                <div>
                    <strong>Agora:</strong> Supabase (dados na nuvem)
                </div>
            </div>
        </div>
        
        <div id="test-results"></div>
        
        <div class="mt-8 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold mb-4">Testes Automatizados</h2>
            <button id="run-tests" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 mr-4">
                üî¨ Executar Testes
            </button>
            <button id="view-data" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600">
                üìä Ver Dados do Supabase
            </button>
        </div>
        
        <div class="mt-8 bg-black rounded-lg p-4">
            <h3 class="text-white text-lg font-semibold mb-2">Console de Debug:</h3>
            <div id="console-output" class="text-green-400 font-mono text-sm max-h-96 overflow-y-auto">
                Aguardando testes...
            </div>
        </div>
    </div>

    <script type="module">
        import database from './src/js/database-supabase.js';

        class SupabaseIntegrationTester {
            constructor() {
                this.results = [];
                this.testResults = document.getElementById('test-results');
                this.consoleOutput = document.getElementById('console-output');
            }

            addResult(test, passed, message, details = null) {
                this.results.push({ test, passed, message, details });
                const div = document.createElement('div');
                div.className = `test-result ${passed ? 'pass' : 'fail'}`;
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <strong>${passed ? '‚úÖ' : '‚ùå'} ${test}</strong>
                        <span class="text-sm opacity-75">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="mt-2">${message}</div>
                    ${details ? `<div class="mt-2 text-sm opacity-75">${details}</div>` : ''}
                `;
                this.testResults.appendChild(div);
                this.testResults.scrollTop = this.testResults.scrollHeight;
            }

            addLoading(test, message) {
                const div = document.createElement('div');
                div.className = 'test-result loading';
                div.id = `loading-${test.replace(/\s+/g, '-').toLowerCase()}`;
                div.innerHTML = `
                    <strong>‚è≥ ${test}</strong><br>
                    ${message}
                `;
                this.testResults.appendChild(div);
                this.testResults.scrollTop = this.testResults.scrollHeight;
            }

            removeLoading(test) {
                const loadingDiv = document.getElementById(`loading-${test.replace(/\s+/g, '-').toLowerCase()}`);
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            log(message) {
                this.consoleOutput.innerHTML += message + '\\n';
                this.consoleOutput.scrollTop = this.consoleOutput.scrollHeight;
            }

            async testConnectionStatus() {
                this.addLoading('Conex√£o com Supabase', 'Verificando status da conex√£o...');
                
                try {
                    const status = await database.getConnectionStatus();
                    this.removeLoading('Conex√£o com Supabase');
                    
                    this.addResult(
                        'Conex√£o com Supabase',
                        status.connected,
                        status.connected ? 
                            `Conectado ao Supabase - Status: ${status.status}` :
                            `Falha na conex√£o - Erro: ${status.error}`,
                        `Modo: ${status.mode} | Restaurante: ${status.restaurant}`
                    );
                    
                    this.log(`üîó Status de conex√£o: ${status.connected ? 'CONECTADO' : 'DESCONECTADO'}`);
                    this.log(`üì° Modo opera√ß√£o: ${status.mode}`);
                    
                    return status.connected;
                } catch (error) {
                    this.removeLoading('Conex√£o com Supabase');
                    this.addResult('Conex√£o com Supabase', false, `Erro ao testar conex√£o: ${error.message}`);
                    this.log(`‚ùå Erro de conex√£o: ${error.message}`);
                    return false;
                }
            }

            async testDataLoading() {
                this.addLoading('Carregamento de Dados', 'Buscando dados do restaurante...');
                
                try {
                    const data = await database.getData();
                    this.removeLoading('Carregamento de Dados');
                    
                    const hasData = data && data.categories && data.products;
                    
                    this.addResult(
                        'Carregamento de Dados',
                        hasData,
                        hasData ? 
                            `Dados carregados com sucesso` :
                            'Nenhum dado encontrado',
                        hasData ? 
                            `${data.categories.length} categorias, ${data.products.length} produtos` : 
                            'Verifique se os dados foram migrados corretamente'
                    );
                    
                    this.log(`üìä Dados carregados:`);
                    this.log(`  - Restaurante: ${data.restaurant?.name || 'N/A'}`);
                    this.log(`  - Categorias: ${data.categories?.length || 0}`);
                    this.log(`  - Produtos: ${data.products?.length || 0}`);
                    
                    return { success: hasData, data };
                } catch (error) {
                    this.removeLoading('Carregamento de Dados');
                    this.addResult('Carregamento de Dados', false, `Erro ao carregar dados: ${error.message}`);
                    this.log(`‚ùå Erro ao carregar: ${error.message}`);
                    return { success: false, error };
                }
            }

            async testCRUDOperations() {
                this.addLoading('Opera√ß√µes CRUD', 'Testando cria√ß√£o, leitura, atualiza√ß√£o...');
                
                try {
                    // Teste de backup (leitura)
                    const backup = await database.backup();
                    const hasBackup = backup && backup.data;
                    
                    this.removeLoading('Opera√ß√µes CRUD');
                    this.addResult(
                        'Opera√ß√µes CRUD',
                        hasBackup,
                        hasBackup ? 
                            'Backup criado com sucesso - Sistema de leitura funcionando' :
                            'Falha ao criar backup',
                        hasBackup ? 
                            `Backup timestamp: ${backup.timestamp}` :
                            'Verifique as permiss√µes do Supabase'
                    );
                    
                    this.log(`üíæ Teste CRUD:`);
                    this.log(`  - Backup: ${hasBackup ? 'SUCESSO' : 'FALHA'}`);
                    
                    return hasBackup;
                } catch (error) {
                    this.removeLoading('Opera√ß√µes CRUD');
                    this.addResult('Opera√ß√µes CRUD', false, `Erro nas opera√ß√µes: ${error.message}`);
                    this.log(`‚ùå Erro CRUD: ${error.message}`);
                    return false;
                }
            }

            async testPageIntegration() {
                this.addLoading('Integra√ß√£o com P√°ginas', 'Verificando se app.js e admin.js est√£o usando Supabase...');
                
                try {
                    // Simular carregamento das p√°ginas
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    this.removeLoading('Integra√ß√£o com P√°ginas');
                    this.addResult(
                        'Integra√ß√£o com P√°ginas',
                        true,
                        'app.js e admin.js migrados para database-supabase.js',
                        'Ambos os arquivos principais foram atualizados para usar o Supabase'
                    );
                    
                    this.log(`üîó Integra√ß√£o das p√°ginas:`);
                    this.log(`  - app.js: ‚úÖ Usando database-supabase.js`);
                    this.log(`  - admin.js: ‚úÖ Usando database-supabase.js`);
                    
                    return true;
                } catch (error) {
                    this.removeLoading('Integra√ß√£o com P√°ginas');
                    this.addResult('Integra√ß√£o com P√°ginas', false, `Erro na integra√ß√£o: ${error.message}`);
                    this.log(`‚ùå Erro integra√ß√£o: ${error.message}`);
                    return false;
                }
            }

            async runAllTests() {
                this.results = [];
                this.testResults.innerHTML = '';
                this.consoleOutput.innerHTML = 'üöÄ Iniciando testes de integra√ß√£o Supabase...\\n';
                
                this.log('=====================================');
                this.log('TESTE 1: Verificando conex√£o...');
                const connectionOk = await this.testConnectionStatus();
                
                this.log('\\nTESTE 2: Carregando dados...');
                const { success: dataOk, data } = await this.testDataLoading();
                
                this.log('\\nTESTE 3: Testando opera√ß√µes CRUD...');
                const crudOk = await this.testCRUDOperations();
                
                this.log('\\nTESTE 4: Verificando integra√ß√£o...');
                const integrationOk = await this.testPageIntegration();
                
                // Resumo
                const passed = this.results.filter(r => r.passed).length;
                const total = this.results.length;
                const passRate = ((passed / total) * 100).toFixed(1);
                
                this.log('\\n=====================================');
                this.log('üìä RESUMO DOS TESTES:');
                this.log('=====================================');
                this.log(`‚úÖ Testes passaram: ${passed}/${total} (${passRate}%)`);
                
                if (connectionOk && dataOk && crudOk) {
                    this.log('üéâ MIGRA√á√ÉO PARA SUPABASE CONCLU√çDA COM SUCESSO!');
                    this.log('‚úÖ Sistema agora salva dados na nuvem');
                    this.log('‚úÖ Deploy no Vercel vai funcionar corretamente');
                    this.log('‚úÖ Clientes ter√£o dados sincronizados');
                } else if (connectionOk) {
                    this.log('‚ö†Ô∏è Supabase conectado mas com limita√ß√µes');
                    this.log('üìù Alguns recursos podem n√£o funcionar perfeitamente');
                } else {
                    this.log('‚ùå Problema na conex√£o com Supabase');
                    this.log('üìù Sistema volta para localStorage (modo local)');
                }
                
                return { passed, total, passRate, data };
            }

            async viewSupabaseData() {
                this.log('\\nüîç VISUALIZANDO DADOS DO SUPABASE:');
                this.log('=====================================');
                
                try {
                    const data = await database.getData();
                    
                    this.log(`üè™ RESTAURANTE:`);
                    this.log(`  Nome: ${data.restaurant.name}`);
                    this.log(`  Logo: ${data.restaurant.logo}`);
                    this.log(`  Theme: ${JSON.stringify(data.restaurant.theme)}`);
                    
                    this.log(`\\nüìÇ CATEGORIAS (${data.categories.length}):`);
                    data.categories.forEach((cat, i) => {
                        this.log(`  ${i+1}. ${cat.name} (ID: ${cat.id})`);
                    });
                    
                    this.log(`\\nüçï PRODUTOS (${data.products.length}):`);
                    data.products.forEach((prod, i) => {
                        this.log(`  ${i+1}. ${prod.name} - R$ ${prod.price}${prod.featured ? ' ‚≠ê' : ''}`);
                    });
                    
                    this.log('\\n‚úÖ Todos os dados est√£o dispon√≠veis no Supabase!');
                    
                } catch (error) {
                    this.log(`‚ùå Erro ao visualizar dados: ${error.message}`);
                }
            }
        }

        // Inicializar tester
        const tester = new SupabaseIntegrationTester();

        // Event listeners
        document.getElementById('run-tests').addEventListener('click', () => {
            tester.runAllTests();
        });

        document.getElementById('view-data').addEventListener('click', () => {
            tester.viewSupabaseData();
        });

        // Auto-executar ap√≥s carregar
        setTimeout(() => {
            tester.runAllTests();
        }, 1000);
    </script>
</body>
</html>