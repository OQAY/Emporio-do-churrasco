<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração Supabase - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h1 class="text-2xl font-bold mb-2">Configuração do Supabase</h1>
                <p class="text-gray-600">Configure a conexão com o banco de dados Supabase para habilitar sincronização em nuvem</p>
            </div>

            <!-- Status de Conexão -->
            <div id="connectionStatus" class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Status da Conexão</h2>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Modo Atual:</span>
                        <span id="currentMode" class="font-medium">Verificando...</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Restaurante:</span>
                        <span id="currentRestaurant" class="font-medium">-</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Supabase Configurado:</span>
                        <span id="supabaseConfigured" class="font-medium">-</span>
                    </div>
                </div>
            </div>

            <!-- Formulário de Configuração -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Credenciais do Supabase</h2>
                
                <form id="supabaseForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            URL do Projeto
                        </label>
                        <input 
                            type="url" 
                            id="supabaseUrl" 
                            placeholder="https://xxxxx.supabase.co"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                            required
                        >
                        <p class="text-xs text-gray-500 mt-1">
                            Encontre em: Settings → API → Project URL
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Chave Anon (Pública)
                        </label>
                        <input 
                            type="text" 
                            id="supabaseKey" 
                            placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                            required
                        >
                        <p class="text-xs text-gray-500 mt-1">
                            Encontre em: Settings → API → anon public
                        </p>
                    </div>

                    <div class="flex gap-3">
                        <button 
                            type="submit" 
                            class="px-6 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 transition-colors"
                        >
                            Conectar ao Supabase
                        </button>
                        <button 
                            type="button" 
                            id="testConnection"
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"
                        >
                            Testar Conexão
                        </button>
                    </div>
                </form>

                <div id="connectionResult" class="mt-4 hidden">
                    <!-- Resultado da conexão aparece aqui -->
                </div>
            </div>

            <!-- Instruções de Setup -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Como Configurar o Supabase</h2>
                
                <ol class="space-y-3 text-sm">
                    <li class="flex">
                        <span class="font-semibold mr-2">1.</span>
                        <div>
                            <strong>Criar conta no Supabase</strong>
                            <p class="text-gray-600">Acesse <a href="https://supabase.com" target="_blank" class="text-orange-500 underline">supabase.com</a> e crie uma conta gratuita</p>
                        </div>
                    </li>
                    <li class="flex">
                        <span class="font-semibold mr-2">2.</span>
                        <div>
                            <strong>Criar novo projeto</strong>
                            <p class="text-gray-600">Nome sugestivo: "cardapio-digital" ou "menu-online"</p>
                        </div>
                    </li>
                    <li class="flex">
                        <span class="font-semibold mr-2">3.</span>
                        <div>
                            <strong>Executar o schema SQL</strong>
                            <p class="text-gray-600">No SQL Editor, cole e execute o conteúdo do arquivo <code class="bg-gray-100 px-1 rounded">supabase-schema.sql</code></p>
                        </div>
                    </li>
                    <li class="flex">
                        <span class="font-semibold mr-2">4.</span>
                        <div>
                            <strong>Configurar Storage</strong>
                            <p class="text-gray-600">Criar bucket "products" com acesso público para imagens</p>
                        </div>
                    </li>
                    <li class="flex">
                        <span class="font-semibold mr-2">5.</span>
                        <div>
                            <strong>Copiar credenciais</strong>
                            <p class="text-gray-600">Em Settings → API, copie a URL e chave anon</p>
                        </div>
                    </li>
                </ol>
            </div>

            <!-- Migração de Dados -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-semibold mb-4">Migração de Dados</h2>
                
                <p class="text-sm text-gray-600 mb-4">
                    Após conectar ao Supabase, você pode migrar os dados locais (localStorage) para a nuvem.
                </p>
                
                <div class="flex gap-3">
                    <button 
                        id="exportLocal"
                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors text-sm"
                    >
                        Exportar Dados Locais
                    </button>
                    <button 
                        id="migrateToSupabase"
                        class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-sm"
                        disabled
                    >
                        Migrar para Supabase
                    </button>
                    <button 
                        id="clearLocal"
                        class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors text-sm"
                    >
                        Limpar Dados Locais
                    </button>
                </div>
                
                <div id="migrationStatus" class="mt-4 hidden">
                    <!-- Status da migração aparece aqui -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import supabaseDatabase from './src/js/supabase-client.js';
        
        // Elementos do DOM
        const form = document.getElementById('supabaseForm');
        const urlInput = document.getElementById('supabaseUrl');
        const keyInput = document.getElementById('supabaseKey');
        const connectionResult = document.getElementById('connectionResult');
        const testBtn = document.getElementById('testConnection');
        const migrateBtn = document.getElementById('migrateToSupabase');
        const exportBtn = document.getElementById('exportLocal');
        const clearBtn = document.getElementById('clearLocal');
        
        // Atualizar status inicial
        updateConnectionStatus();
        
        // Carregar configuração salva
        const savedUrl = localStorage.getItem('SUPABASE_URL');
        const savedKey = localStorage.getItem('SUPABASE_ANON_KEY');
        if (savedUrl) urlInput.value = savedUrl;
        if (savedKey) keyInput.value = savedKey;
        
        // Atualizar status da conexão
        function updateConnectionStatus() {
            const status = supabaseDatabase.getConnectionStatus();
            
            document.getElementById('currentMode').textContent = 
                status.isOnline ? 'Online (Supabase)' : 'Offline (localStorage)';
            
            document.getElementById('currentMode').className = 
                status.isOnline ? 'font-medium text-green-600' : 'font-medium text-yellow-600';
            
            document.getElementById('currentRestaurant').textContent = 
                status.currentRestaurant?.name || status.currentRestaurant?.subdomain || 'Demo Local';
            
            document.getElementById('supabaseConfigured').textContent = 
                status.hasSupabaseConfig ? 'Sim' : 'Não';
            
            document.getElementById('supabaseConfigured').className = 
                status.hasSupabaseConfig ? 'font-medium text-green-600' : 'font-medium text-red-600';
            
            // Habilitar botão de migração se conectado
            migrateBtn.disabled = !status.isOnline;
        }
        
        // Configurar Supabase
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const url = urlInput.value.trim();
            const key = keyInput.value.trim();
            
            showMessage('Conectando ao Supabase...', 'info');
            
            try {
                const connected = await supabaseDatabase.configureSupabase(url, key);
                
                if (connected) {
                    showMessage('Conectado com sucesso ao Supabase!', 'success');
                    updateConnectionStatus();
                } else {
                    showMessage('Falha na conexão. Verifique as credenciais.', 'error');
                }
            } catch (error) {
                showMessage('Erro: ' + error.message, 'error');
            }
        });
        
        // Testar conexão
        testBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();
            const key = keyInput.value.trim();
            
            if (!url || !key) {
                showMessage('Preencha URL e chave primeiro', 'warning');
                return;
            }
            
            showMessage('Testando conexão...', 'info');
            
            try {
                // Testar importação do Supabase
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const testClient = createClient(url, key);
                
                // Testar query simples
                const { data, error } = await testClient
                    .from('restaurants')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    showMessage('Erro na conexão: ' + error.message, 'error');
                } else {
                    showMessage('Conexão testada com sucesso!', 'success');
                }
            } catch (error) {
                showMessage('Erro ao testar: ' + error.message, 'error');
            }
        });
        
        // Exportar dados locais
        exportBtn.addEventListener('click', () => {
            const data = localStorage.getItem('restaurantData');
            if (!data) {
                showMessage('Nenhum dado local encontrado', 'warning');
                return;
            }
            
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-local-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('Dados exportados com sucesso', 'success');
        });
        
        // Migrar para Supabase
        migrateBtn.addEventListener('click', async () => {
            if (!confirm('Isso irá migrar todos os dados locais para o Supabase. Continuar?')) {
                return;
            }
            
            const migrationDiv = document.getElementById('migrationStatus');
            migrationDiv.classList.remove('hidden');
            migrationDiv.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                    <p class="text-sm text-blue-700">Migrando dados...</p>
                    <div class="mt-2">
                        <div class="bg-blue-200 rounded-full h-2 overflow-hidden">
                            <div class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const localData = JSON.parse(localStorage.getItem('restaurantData') || '{}');
                
                // Marcar dados para sincronização
                localData.needsSync = true;
                
                // Marcar itens como locais
                if (localData.categories) {
                    localData.categories = localData.categories.map(cat => ({
                        ...cat,
                        localOnly: true
                    }));
                }
                
                if (localData.products) {
                    localData.products = localData.products.map(prod => ({
                        ...prod,
                        localOnly: true
                    }));
                }
                
                localStorage.setItem('restaurantData', JSON.stringify(localData));
                
                // Sincronizar
                await supabaseDatabase.syncLocalToSupabase();
                
                migrationDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded p-3">
                        <p class="text-sm text-green-700">Migração concluída com sucesso!</p>
                    </div>
                `;
                
                setTimeout(() => {
                    migrationDiv.classList.add('hidden');
                }, 5000);
                
            } catch (error) {
                migrationDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded p-3">
                        <p class="text-sm text-red-700">Erro na migração: ${error.message}</p>
                    </div>
                `;
            }
        });
        
        // Limpar dados locais
        clearBtn.addEventListener('click', () => {
            if (!confirm('ATENÇÃO: Isso irá apagar TODOS os dados locais. Tem certeza?')) {
                return;
            }
            
            if (!confirm('Última chance: Você fez backup dos dados?')) {
                return;
            }
            
            localStorage.removeItem('restaurantData');
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('authTime');
            
            showMessage('Dados locais removidos', 'success');
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        });
        
        // Função auxiliar para mostrar mensagens
        function showMessage(message, type) {
            connectionResult.classList.remove('hidden');
            
            const colors = {
                success: 'bg-green-50 border-green-200 text-green-700',
                error: 'bg-red-50 border-red-200 text-red-700',
                warning: 'bg-yellow-50 border-yellow-200 text-yellow-700',
                info: 'bg-blue-50 border-blue-200 text-blue-700'
            };
            
            connectionResult.innerHTML = `
                <div class="border rounded p-3 ${colors[type] || colors.info}">
                    <p class="text-sm">${message}</p>
                </div>
            `;
            
            if (type !== 'info') {
                setTimeout(() => {
                    connectionResult.classList.add('hidden');
                }, 5000);
            }
        }
    </script>
</body>
</html>